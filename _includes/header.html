{% assign url_parts = page.url | split: "/" %}
{% if url_parts.size > 0 %}
  
  {% assign last_url_part = url_parts | last %}

  {% comment %} Does the URL contain a filename, and is it an index.html or not? {% endcomment %}
  {% if last_url_part contains ".html" %}
    {% assign url_has_filename = true %}
    {% if last_url_part == 'index.html' %}
      {% assign url_filename_is_index = true %}
    {% else %}
      {% assign url_filename_is_index = false %}
    {% endif %}
  {% else %}
    {% assign url_has_filename = false %}
  {% endif %}

  {% comment %} 
    MCdeskCon URLs require some special consideration, because it's a specialization
    of the /events URL which is itself a child of Community; te MCdeskCon menu is NOT
    a child of Community.
  {% endcomment %}
  {% if page.url contains "mcdeskcon" %}
    {% assign is_conference_page = true %}
  {% else %}
    {% assign is_conference_page = false %}
  {% endif %}

  {% if is_conference_page %}
    {% comment %}
      If the page is a confernce page and it has a filename then its the penultimate
      path component that has the child menu item of the MCdeskCon that needs
      to be marked as in-category. If there's no filename then reference the ultimate
      path component.
      Unless the filename is mcdeskcon2023-cfp, because it's a one off that is not
      within the /events/mcdeskcon/... structure.
    {% endcomment %}
    {% if url_has_filename %}
      {% unless page.url contains 'mcdeskcon2023-cfp' %}
        {% assign url_fragment_index = url_parts | size | minus: 2 %}
        {% assign url_fragment = url_parts[url_fragment_index] %}
      {% else %}
        {% assign url_fragment = 'mcdeskcon2023-cfp' %}
      {% endunless %}
    {% else %}
      {% assign url_fragment = last_url_part %}
    {% endif %}
  {% else %}
    {% comment %}
      If the page is NOT a conference page, the URL has a filename, and the filename
      is NOT index.html then refer to the filename without the .html extension.
      If the filename is index.html then refer to the penultimate path component.
      If there is not filename then refer to the ultimate path component.
    {% endcomment %}
    {% if url_has_filename %}
      {% unless url_filename_is_index %}
        {% assign url_fragment = last_url_part | replace: '.html', '' %}
      {% else %}
        {% assign url_fragment_index = url_parts | size |  minus: 2 %}
        {% assign url_fragment = url_parts[url_fragment_index] %}
      {% endunless %}
    {% else %}
      {% assign url_fragment = last_url_part %}
    {% endif %}
  {% endif %}
{% else %}
  {% assign url_fragment = '' %}
{% endif %}
{% if page.alert %}
<div role="banner" class="banner-alert">
  <div class="container">
    {{ page.alert | markdownify }}
  </div>
</div>
{% endif %}
{% if site.data.alert.message %}
<div role="banner" class="banner-alert">
  <div class="container">
  {{site.data.alert.message | markdownify}}
  </div>
</div>
{% endif %}
<div role="banner" id="top">
</div>
<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    const menu = document.querySelector('#top .nav-menu-on');
    const button = document.querySelector('#top .menu-button');
    button.addEventListener('click', () => {
        menu.classList.toggle('active');
        button.classList.toggle('active');
    });
  });
  document.addEventListener('DOMContentLoaded', () => {
    function getSubMenu(button) {
        const parentLI = button.closest('li');
        const childUL = parentLI.querySelector('ul');
        return childUL;
    }
    function initializeCustomMenuHeights(button) {
        const childUL = getSubMenu(button);
        const height = childUL?.scrollHeight;
        childUL?.style?.setProperty?.('--expanded-height', `${height}px`);
        childUL?.classList?.add?.('nested-nav--menu__mobile-hidden-collapsed');
    }
    function onNestedNavMenuTransitionEnd(e) {
        const { target } = e;
        if (!target?.hasAttribute?.('expanded')) {
            target?.classList.add('nested-nav--menu__mobile-hidden-collapsed');
        }
    }

    function onToggleButtonClick(e) {
        const visibleClassName = 'mcdesk-toggle-button-link__visible';
        const visibleSelector = `.${visibleClassName}`;
        const invisibleClassName = 'mcdesk-toggle-button-link__invisible';
        const invisibleSelector = `.${invisibleClassName}`;

        const toggle = e.currentTarget;
        const visibleLink = toggle.querySelector(visibleSelector);
        const invisibleLink = toggle.querySelector(invisibleSelector);
        visibleLink.classList.remove(visibleClassName);
        visibleLink.classList.add(invisibleClassName);
        invisibleLink.classList.remove(invisibleClassName);
        invisibleLink.classList.add(visibleClassName);

        const childUL = getSubMenu(toggle);
        const isAlreadyExpanded = childUL?.getAttribute?.('expanded') ?? false;
        if (childUL.classList.contains('nested-nav--menu__mobile-hidden-collapsed')) {
            childUL?.classList?.remove?.('nested-nav--menu__mobile-hidden-collapsed');
        }
        window.setTimeout(() => childUL?.toggleAttribute?.('expanded'), 60);
    }

    document.querySelector('#top .navigation-container--nested-nav-wrapper--nested-nav')?.addEventListener?.('transitionend', onNestedNavMenuTransitionEnd);
    const topNavigationToggleButtons = document.querySelectorAll('#top .mcdesk-toggle-button--wrapper');
    for (let i = 0; i < topNavigationToggleButtons.length; ++i) {
        const button = topNavigationToggleButtons[i];
        initializeCustomMenuHeights(button);
        button.addEventListener('click', onToggleButtonClick);
    }
  });
</script>